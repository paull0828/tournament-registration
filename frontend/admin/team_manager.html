<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Teams - Admin Panel</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Reset */
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #fff;
        font-weight: 600;
        margin-bottom: 25px;
        font-size: 2.2rem;
        text-align: center;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .team-creation {
        background: #fff;
        border-radius: 15px;
        padding: 25px 30px;
        width: 100%;
        max-width: 480px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.3s ease;
      }

      .team-creation:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      }

      label {
        display: block;
        margin-top: 20px;
        font-weight: 600;
        color: #4a4a4a;
        font-size: 0.95rem;
      }

      input[type="text"],
      select {
        width: 100%;
        margin-top: 8px;
        padding: 12px 15px;
        font-size: 1rem;
        border-radius: 8px;
        border: 1.8px solid #ddd;
        transition: border-color 0.3s ease;
        outline-offset: 2px;
      }

      input[type="text"]:focus,
      select:focus {
        border-color: #667eea;
        outline: none;
      }

      input[type="file"] {
        margin-top: 12px;
      }

      button {
        margin-top: 25px;
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        background: #667eea;
        color: white;
        cursor: pointer;
        box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }

      button:hover:not(:disabled) {
        background-color: #5a6ddb;
        box-shadow: 0 12px 20px rgba(90, 109, 219, 0.6);
      }

      button:disabled {
        background: #bbb;
        cursor: not-allowed;
        box-shadow: none;
      }

      .players-list,
      .selected-players,
      .captain-selection {
        background: #f9faff;
        border-radius: 12px;
        padding: 15px 20px;
        margin-top: 20px;
        box-shadow: inset 0 0 8px rgba(102, 126, 234, 0.2);
      }

      .selected-players strong {
        font-weight: 700;
        color: #3e3e3e;
      }

      #selectedPlayersList {
        margin-top: 10px;
        max-height: 140px;
        overflow-y: auto;
        padding-left: 18px;
        color: #555;
        font-size: 0.95rem;
      }

      #selectedPlayersList li {
        margin-bottom: 8px;
      }

      /* Captain & Vice Captain selection */
      .captain-selection label {
        margin-top: 15px;
        font-weight: 600;
        color: #4a4a4a;
      }

      #captainSelect,
      #viceCaptainSelect {
        margin-top: 8px;
      }

      hr {
        margin: 40px 0 25px;
        border: none;
        border-top: 1px solid #ddd;
        width: 100%;
        max-width: 480px;
      }

      h2 {
        color: #fff;
        text-align: center;
        font-weight: 600;
        font-size: 1.7rem;
        margin-bottom: 25px;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      #teamsContainer {
        width: 100%;
        max-width: 480px;
      }

      .team-card {
        background: #fff;
        padding: 18px 22px;
        border-radius: 15px;
        margin-bottom: 22px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        transition: transform 0.3s ease;
      }

      .team-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .team-card h3 {
        margin-top: 0;
        font-weight: 700;
        font-size: 1.5rem;
        color: #333;
      }

      .team-logo {
        max-width: 110px;
        border-radius: 12px;
        margin: 15px 0;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .team-card ul {
        padding-left: 20px;
        color: #555;
        margin-bottom: 12px;
        font-size: 0.95rem;
      }

      .team-card p {
        margin: 6px 0;
        font-weight: 600;
        color: #444;
      }

      /* Scrollbar for selected players */
      #selectedPlayersList::-webkit-scrollbar {
        width: 6px;
      }

      #selectedPlayersList::-webkit-scrollbar-thumb {
        background-color: #667eea;
        border-radius: 10px;
      }

      /* Responsive adjustments */
      @media (max-width: 520px) {
        body {
          padding: 15px 12px;
        }

        .team-creation,
        #teamsContainer {
          max-width: 100%;
          padding: 20px;
        }

        button {
          font-size: 1rem;
          padding: 14px;
        }

        h1 {
          font-size: 1.8rem;
        }

        h2 {
          font-size: 1.4rem;
        }

        .team-card h3 {
          font-size: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <h1>Create Teams</h1>

    <div class="team-creation">
      <label for="teamName">Team Name:</label>
      <input type="text" id="teamName" placeholder="Enter team name" />

      <label for="teamLogo">Team Logo:</label>
      <input type="file" id="teamLogo" accept="image/*" />

      <label for="playersSelect">Add Players (max 11):</label>
      <select id="playersSelect">
        <option value="">-- Select Player --</option>
      </select>
      <button id="addPlayerBtn" disabled>Add Player</button>

      <div class="selected-players" id="selectedPlayers">
        <strong>Selected Players:</strong>
        <ul id="selectedPlayersList"></ul>
      </div>

      <!-- Captain & Vice Captain selection UI (hidden until 11 players selected) -->
      <div class="captain-selection" id="captainSection" style="display: none">
        <label for="captainSelect">Select Captain:</label>
        <select id="captainSelect">
          <option value="">-- Select Captain --</option>
        </select>

        <label for="viceCaptainSelect">Select Vice Captain:</label>
        <select id="viceCaptainSelect">
          <option value="">-- Select Vice Captain --</option>
        </select>
      </div>

      <button id="createTeamBtn" disabled>Create Team</button>
    </div>

    <hr />

    <h2>Created Teams (max 4)</h2>
    <div id="teamsContainer"></div>
    <script>
      const maxTeams = 4;
      const maxPlayersPerTeam = 11;

      const createdTeams = [];
      let selectedPlayers = [];
      let allPlayers = [];

      // DOM Elements
      const playersSelect = document.getElementById("playersSelect");
      const addPlayerBtn = document.getElementById("addPlayerBtn");
      const selectedPlayersList = document.getElementById(
        "selectedPlayersList"
      );
      const createTeamBtn = document.getElementById("createTeamBtn");
      const teamNameInput = document.getElementById("teamName");
      const captainSection = document.getElementById("captainSection");
      const captainSelect = document.getElementById("captainSelect");
      const viceCaptainSelect = document.getElementById("viceCaptainSelect");

      async function fetchRegisteredPlayers() {
        try {
          const res = await fetch(
            "https://tournament-registration-2.onrender.com/api/teams/unassigned-players"
          );
          if (!res.ok) throw new Error("Failed to fetch players");
          const players = await res.json();
          return players;
        } catch (err) {
          alert(err.message);
          return [];
        }
      }

      function populatePlayerSelect(players) {
        playersSelect.innerHTML =
          '<option value="">-- Select Player --</option>';
        players.forEach((player) => {
          const option = document.createElement("option");
          option.value = player._id;
          option.textContent = `${player.firstName} ${player.lastName} (${
            player.nickName || "No nickname"
          })`;
          playersSelect.appendChild(option);
        });
        checkAddPlayerButton();
      }

      function renderSelectedPlayers() {
        selectedPlayersList.innerHTML = "";
        selectedPlayers.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = `${p.firstName} ${p.lastName}`;
          selectedPlayersList.appendChild(li);
        });
        checkAddPlayerButton();
        checkCreateTeamButton();

        // Show captain selection only when exactly 11 players are selected
        if (selectedPlayers.length === maxPlayersPerTeam) {
          populateCaptainViceCaptainSelects();
          captainSection.style.display = "block";
        } else {
          captainSection.style.display = "none";
          // reset captain and vice captain selects when players less than 11
          captainSelect.value = "";
          viceCaptainSelect.value = "";
        }
      }

      function checkAddPlayerButton() {
        addPlayerBtn.disabled =
          !playersSelect.value || selectedPlayers.length >= maxPlayersPerTeam;
      }

      function checkCreateTeamButton() {
        const teamName = teamNameInput.value.trim();

        // captain and vice captain validation
        const captainSelected = captainSelect.value !== "";
        const viceCaptainSelected = viceCaptainSelect.value !== "";
        const captainDiffVice = captainSelect.value !== viceCaptainSelect.value;

        createTeamBtn.disabled = !(
          teamName &&
          selectedPlayers.length === maxPlayersPerTeam &&
          captainSelected &&
          viceCaptainSelected &&
          captainDiffVice
        );
      }

      function addPlayer(playerId) {
        if (selectedPlayers.length >= maxPlayersPerTeam) {
          alert(`You can add max ${maxPlayersPerTeam} players per team`);
          return;
        }
        const player = allPlayers.find((p) => p._id === playerId);
        if (!player) return;
        if (selectedPlayers.find((p) => p._id === playerId)) {
          alert("Player already added");
          return;
        }
        selectedPlayers.push(player);
        renderSelectedPlayers();
        // reset select
        playersSelect.value = "";
        checkAddPlayerButton();
      }

      // Populate captain and vice captain dropdowns from selected players
      function populateCaptainViceCaptainSelects() {
        [captainSelect, viceCaptainSelect].forEach((select) => {
          select.innerHTML = '<option value="">-- Select --</option>';
          selectedPlayers.forEach((p) => {
            const option = document.createElement("option");
            option.value = p._id;
            option.textContent = `${p.firstName} ${p.lastName}`;
            select.appendChild(option);
          });
        });
        checkCreateTeamButton();
      }

      // Render created teams on page
      function renderCreatedTeams() {
        const container = document.getElementById("teamsContainer");
        container.innerHTML = "";
        createdTeams.forEach((team) => {
          const div = document.createElement("div");
          div.className = "team-card";

          let logoHtml = "";
          if (team.logoUrl) {
            logoHtml = `<img src="${team.logoUrl}" alt="Team Logo" class="team-logo" />`;
          }

          div.innerHTML = `
            <h3>${team.name}</h3>
            ${logoHtml}
            <p><strong>Players (${team.players.length}):</strong></p>
            <ul>
              ${team.players
                .map((p) => `<li>${p.firstName} ${p.lastName}</li>`)
                .join("")}
            </ul>
            <p><strong>Captain:</strong> ${team.captainName}</p>
            <p><strong>Vice Captain:</strong> ${team.viceCaptainName}</p>
          `;
          container.appendChild(div);
        });
      }

      // Convert logo file to base64 URL (demo only)
      function readLogoFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject("Failed to read logo file");
          reader.readAsDataURL(file);
        });
      }

      async function createTeam() {
        if (createdTeams.length >= maxTeams) {
          alert(`You can create maximum ${maxTeams} teams only.`);
          return;
        }

        const teamName = teamNameInput.value.trim();
        if (!teamName) {
          alert("Please enter a team name.");
          return;
        }

        if (selectedPlayers.length !== maxPlayersPerTeam) {
          alert(`Please select exactly ${maxPlayersPerTeam} players.`);
          return;
        }

        const captainId = captainSelect.value;
        const viceCaptainId = viceCaptainSelect.value;

        if (!captainId || !viceCaptainId) {
          alert("Please select both captain and vice captain.");
          return;
        }
        if (captainId === viceCaptainId) {
          alert("Captain and Vice Captain cannot be the same player.");
          return;
        }

        // Prepare players IDs list
        const playersIds = selectedPlayers.map((p) => p._id);

        // Get captain and vice captain full names for display
        const captainObj = selectedPlayers.find((p) => p._id === captainId);
        const viceCaptainObj = selectedPlayers.find(
          (p) => p._id === viceCaptainId
        );

        // Read logo file (optional)
        const logoFile = document.getElementById("teamLogo").files[0];
        let logoUrl = "";
        if (logoFile) {
          try {
            logoUrl = await readLogoFile(logoFile);
          } catch (e) {
            alert("Failed to read logo file");
            return;
          }
        }

        // Prepare team data to send to backend
        const teamData = {
          name: teamName,
          logoUrl: logoUrl, // base64 string or empty
          players: playersIds,
          captain: captainId,
          viceCaptain: viceCaptainId,
        };
        console.log("Team data to send:", teamData);
        // POST request to backend API
        try {
          const res = await fetch(
            "https://tournament-registration-2.onrender.com/api/teams/create",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(teamData),
            }
          );
          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.message || "Failed to create team");
          }
          const createdTeam = await res.json();

          // Add to local createdTeams for display
          createdTeams.push({
            name: createdTeam.name,
            logoUrl: logoUrl,
            players: selectedPlayers,
            captainName: `${captainObj.firstName} ${captainObj.lastName}`,
            viceCaptainName: `${viceCaptainObj.firstName} ${viceCaptainObj.lastName}`,
          });

          // Reset form and state
          teamNameInput.value = "";
          document.getElementById("teamLogo").value = "";
          selectedPlayers = [];
          captainSelect.value = "";
          viceCaptainSelect.value = "";
          captainSection.style.display = "none";
          renderSelectedPlayers();
          renderCreatedTeams();
          alert("Team created successfully!");
        } catch (err) {
          alert(err.message);
        }
      }

      // Event listeners
      addPlayerBtn.addEventListener("click", () => {
        if (playersSelect.value) addPlayer(playersSelect.value);
      });

      playersSelect.addEventListener("change", checkAddPlayerButton);

      teamNameInput.addEventListener("input", checkCreateTeamButton);

      captainSelect.addEventListener("change", checkCreateTeamButton);
      viceCaptainSelect.addEventListener("change", checkCreateTeamButton);

      createTeamBtn.addEventListener("click", createTeam);

      // Initial fetch and populate players
      (async () => {
        allPlayers = await fetchRegisteredPlayers();
        populatePlayerSelect(allPlayers);
      })();
    </script>
  </body>
</html>
